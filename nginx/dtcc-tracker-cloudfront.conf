# DTCC Tracker - Nginx Configuration for CloudFront
# This configuration works behind CloudFront CDN with ACM certificate
# CloudFront handles HTTPS, this server handles HTTP only

# CloudFront IP ranges for real IP detection
# These should be updated periodically from: https://ip-ranges.amazonaws.com/ip-ranges.json
set_real_ip_from 13.32.0.0/15;
set_real_ip_from 13.35.0.0/16;
set_real_ip_from 18.64.0.0/14;
set_real_ip_from 18.68.0.0/16;
set_real_ip_from 18.154.0.0/15;
set_real_ip_from 18.156.0.0/15;
set_real_ip_from 18.158.0.0/15;
set_real_ip_from 18.160.0.0/15;
set_real_ip_from 18.164.0.0/15;
set_real_ip_from 18.172.0.0/15;
set_real_ip_from 18.200.0.0/16;
set_real_ip_from 18.204.0.0/14;
set_real_ip_from 18.208.0.0/13;
set_real_ip_from 18.244.0.0/15;
set_real_ip_from 52.46.0.0/18;
set_real_ip_from 52.82.0.0/15;
set_real_ip_from 52.84.0.0/15;
set_real_ip_from 52.222.128.0/17;
set_real_ip_from 54.182.0.0/16;
set_real_ip_from 54.192.0.0/16;
set_real_ip_from 54.230.0.0/16;
set_real_ip_from 54.239.128.0/18;
set_real_ip_from 54.239.192.0/19;
set_real_ip_from 54.240.128.0/18;
set_real_ip_from 58.254.138.0/25;
set_real_ip_from 99.79.169.0/24;
set_real_ip_from 99.84.0.0/16;
set_real_ip_from 99.86.0.0/16;
set_real_ip_from 130.176.0.0/16;
set_real_ip_from 143.204.0.0/16;
set_real_ip_from 144.220.0.0/16;
set_real_ip_from 204.246.164.0/22;
set_real_ip_from 204.246.168.0/22;
set_real_ip_from 204.246.172.0/23;
set_real_ip_from 204.246.174.0/23;
set_real_ip_from 204.246.176.0/20;
set_real_ip_from 205.251.192.0/19;
set_real_ip_from 205.251.249.0/24;
set_real_ip_from 205.251.250.0/23;
set_real_ip_from 205.251.252.0/23;
set_real_ip_from 205.251.254.0/24;
set_real_ip_from 2600:9000::/28;
real_ip_header X-Forwarded-For;
real_ip_recursive on;

# Upstream backend server
upstream backend {
    server 127.0.0.1:8000;
    keepalive 64;
}

# Upstream frontend server
upstream frontend {
    server 127.0.0.1:3000;
    keepalive 64;
}

# HTTP server - receives traffic from CloudFront
server {
    listen 80;
    listen [::]:80;
    server_name _;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Note: HSTS is set by CloudFront, not here

    # Backend API
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;

        # Preserve CloudFront headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header CloudFront-Viewer-Country $http_cloudfront_viewer_country;
        proxy_set_header Connection "";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Disable caching for API
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }

    # Admin panel
    location /admin/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";

        # Disable caching for admin
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }

    # Static files for Django
    location /static/ {
        alias /home/ubuntu/dtcc-tracker/backend/staticfiles/;
        expires 365d;
        add_header Cache-Control "public, immutable";

        # Allow CloudFront to cache aggressively
        add_header X-Content-Type-Options "nosniff";
    }

    # Media files for Django
    location /media/ {
        alias /home/ubuntu/dtcc-tracker/backend/media/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Frontend application
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;

        # Preserve CloudFront headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header CloudFront-Viewer-Country $http_cloudfront_viewer_country;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Disable buffering for Next.js
        proxy_buffering off;

        # Cache control for HTML pages
        add_header Cache-Control "public, max-age=0, must-revalidate" always;
    }

    # Health check endpoint for CloudFront origin health checks
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
}
