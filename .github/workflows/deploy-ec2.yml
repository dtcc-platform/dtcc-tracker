name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        HOSTNAME: ${{ secrets.EC2_HOST }}
        USER_NAME: ${{ secrets.EC2_USER }}
      run: |
        echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
        ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '
          # Navigate to app directory
          cd /home/ubuntu/dtcc-tracker || mkdir -p /home/ubuntu/dtcc-tracker
          cd /home/ubuntu/dtcc-tracker

          # Pull latest code
          if [ -d ".git" ]; then
            git pull origin main
          else
            git clone https://github.com/${{ github.repository }}.git .
          fi

          # ================================================
          # BACKEND DEPLOYMENT
          # ================================================
          echo "=========================================="
          echo "Deploying Backend (Django)"
          echo "=========================================="

          cd backend

          # Install/update Python dependencies
          python3.11 -m venv venv || python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Stop existing backend service
          sudo systemctl stop dtcc-tracker-backend || true

          # Copy backend service file if it doesnt exist
          if [ ! -f "/etc/systemd/system/dtcc-tracker-backend.service" ]; then
            sudo cp dtcc-tracker-backend.service /etc/systemd/system/
            sudo systemctl daemon-reload
          fi

          # Set environment variables for backend
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" > .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env

          # Run database migrations
          python manage.py migrate --no-input

          # Collect static files
          python manage.py collectstatic --no-input

          # Start backend service
          sudo systemctl start dtcc-tracker-backend
          sudo systemctl enable dtcc-tracker-backend

          # Check backend status
          sudo systemctl status dtcc-tracker-backend --no-pager

          deactivate
          cd ..

          # ================================================
          # FRONTEND DEPLOYMENT
          # ================================================
          echo "=========================================="
          echo "Deploying Frontend (Next.js)"
          echo "=========================================="

          cd frontend

          # Install/update Node dependencies
          npm ci

          # Build Next.js application
          npm run build

          # Stop existing frontend service
          sudo systemctl stop dtcc-tracker-frontend || true

          # Copy frontend service file if it doesnt exist
          if [ ! -f "/etc/systemd/system/dtcc-tracker-frontend.service" ]; then
            sudo cp dtcc-tracker-frontend.service /etc/systemd/system/
            sudo systemctl daemon-reload
          fi

          # Set environment variables for frontend
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" > .env.production.local

          # Start frontend service
          sudo systemctl start dtcc-tracker-frontend
          sudo systemctl enable dtcc-tracker-frontend

          # Check frontend status
          sudo systemctl status dtcc-tracker-frontend --no-pager

          cd ..

          # ================================================
          # NGINX DEPLOYMENT
          # ================================================
          echo "=========================================="
          echo "Configuring Nginx Reverse Proxy"
          echo "=========================================="

          # Install nginx if not already installed
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            sudo apt-get update
            sudo apt-get install -y nginx
          else
            echo "Nginx already installed"
          fi

          # Copy nginx configuration
          sudo cp nginx/dtcc-tracker.conf /etc/nginx/sites-available/dtcc-tracker.conf

          # Create symlink if it doesnt exist
          if [ ! -f "/etc/nginx/sites-enabled/dtcc-tracker.conf" ]; then
            sudo ln -s /etc/nginx/sites-available/dtcc-tracker.conf /etc/nginx/sites-enabled/
          fi

          # Remove default nginx site if it exists
          sudo rm -f /etc/nginx/sites-enabled/default

          # Create directory for certbot challenges
          sudo mkdir -p /var/www/certbot

          # Test nginx configuration
          sudo nginx -t

          # Reload nginx
          sudo systemctl reload nginx
          sudo systemctl enable nginx

          # Check nginx status
          sudo systemctl status nginx --no-pager

          # ================================================
          # DEPLOYMENT COMPLETE
          # ================================================
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo "Backend: Running on localhost:8000 (via Nginx)"
          echo "Frontend: Running on localhost:3000 (via Nginx)"
          echo "Nginx: Serving on port 80 (HTTP) and 443 (HTTPS)"
        '
